<script src="https://cdn.tailwindcss.com"></script>
<style>
* { font-family: 'Inter', sans-serif; }
/* Typography */
.val       { font-weight: 600; line-height: 1.1; }
.val-xxl   { font-size: 4rem; }
.val-sm    { font-size: 1rem; }
.tnums     { font-variant-numeric: tabular-nums; }

.ttl       { font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 1rem; }
.ttl-sm    { font-size: 0.875rem; }

.lbl       { font-size: 0.9375rem; }
.lbl-sm    { font-size: 0.8125rem; }
.lbl-md    { font-size: 1.0625rem; }
.lbl-gray  { color: #888; }

.desc      { font-size: 1rem; }

/* Separators */
.sep       { height: 1px; background: #000; width: 100%; }
.sep-v     { width: 1px; background: #000; align-self: stretch; }

/* Equal panels (sep-v excluded) */

/* Item rows */
.item-row         { display: flex; gap: 0.5rem; align-items: baseline; }
.item-row .meta   { flex-shrink: 0; }
</style>

{%- comment -%}=== Weather Icon SVGs ==={%- endcomment -%}

{%- capture svg_sunny -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="none" stroke="black" stroke-width="2.5" stroke-linecap="round"><circle cx="16" cy="16" r="5" fill="black"/><line x1="16" y1="3" x2="16" y2="7"/><line x1="16" y1="25" x2="16" y2="29"/><line x1="5.4" y1="5.4" x2="8.2" y2="8.2"/><line x1="23.8" y1="23.8" x2="26.6" y2="26.6"/><line x1="3" y1="16" x2="7" y2="16"/><line x1="25" y1="16" x2="29" y2="16"/><line x1="5.4" y1="26.6" x2="8.2" y2="23.8"/><line x1="23.8" y1="8.2" x2="26.6" y2="5.4"/></svg>{%- endcapture -%}

{%- capture svg_cloudy -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="black"><path d="M8 24c-3 0-5.5-2.5-5.5-5.5 0-2.7 2-5 4.6-5.4C8.3 9.5 11.5 7 15.5 7c4.8 0 8.7 3.6 9 8.2C26.8 16 28.5 18 28.5 20.2c0 2.5-2 3.8-4 3.8H8z"/></svg>{%- endcapture -%}

{%- capture svg_rainy -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="black" d="M8 19c-3 0-5.5-2.5-5.5-5.5 0-2.7 2-5 4.6-5.4C8.3 4.5 11.5 2 15.5 2c4.8 0 8.7 3.6 9 8.2C26.8 11 28.5 13 28.5 15.2c0 2.5-2 3.8-4 3.8H8z"/><line x1="10" y1="23" x2="8" y2="29" stroke="black" stroke-width="2.5" stroke-linecap="round"/><line x1="16" y1="23" x2="14" y2="29" stroke="black" stroke-width="2.5" stroke-linecap="round"/><line x1="22" y1="23" x2="20" y2="29" stroke="black" stroke-width="2.5" stroke-linecap="round"/></svg>{%- endcapture -%}

{%- capture svg_partly_cloudy -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><circle cx="12" cy="9" r="4" fill="none" stroke="black" stroke-width="2"/><line x1="12" y1="1" x2="12" y2="3" stroke="black" stroke-width="2" stroke-linecap="round"/><line x1="6.3" y1="3.3" x2="7.7" y2="4.7" stroke="black" stroke-width="2" stroke-linecap="round"/><line x1="4" y1="9" x2="6" y2="9" stroke="black" stroke-width="2" stroke-linecap="round"/><line x1="6.3" y1="14.7" x2="7.7" y2="13.3" stroke="black" stroke-width="2" stroke-linecap="round"/><path fill="black" d="M10 26c-2.5 0-4.5-2-4.5-4.5 0-2.2 1.6-4 3.7-4.4C10 14 12.8 12 16 12c3.8 0 6.9 2.9 7.2 6.5 1.8.7 3.3 2.5 3.3 4.2 0 2.2-1.7 3.3-3.5 3.3H10z"/></svg>{%- endcapture -%}

{%- capture svg_home -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>{%- endcapture -%}

<script src="https://trmnl.com/js/highcharts/12.3.0/highcharts.js"></script>

<div class="flex flex-col gap-4 grow min-h-0 p-2">

  {%- comment -%}=== TOP: Home Sensors ==={%- endcomment -%}
  <div class="flex gap-4 top-panels">

    {%- comment -%}--- DOMA panel ---{%- endcomment -%}
    <div class="flex flex-col gap-2" style="flex: 1.7 1 0; min-width: 0;">
      <div class="flex items-center gap-4">
        <span class="val val-xxl tnums" data-pixel-perfect="true">{{ sensors.indoor.temp }}°</span>
        <div class="flex flex-col gap-1">
          <span class="val text-3xl tnums !leading-none whitespace-nowrap">{{ sensors.indoor.humidity }}&thinsp;% <span class="lbl lbl-md lbl-gray">vlhkost</span></span>
          <span class="val text-3xl tnums !leading-none whitespace-nowrap">{{ sensors.indoor.co2 }}&thinsp;<span class="text-lg">ppm</span> <span class="lbl lbl-md lbl-gray">CO₂</span></span>
        </div>
      </div>
      <div class="flex justify-between grow items-center">
        {% for room in sensors.rooms %}
          <div class="flex flex-col items-center gap-0">
            <span class="lbl lbl-md lbl-gray">{{ room.name }}</span>
            <span class="val text-3xl tnums">{{ room.temp }}°</span>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="sep-v"></div>

    {%- comment -%}--- VENKU panel ---{%- endcomment -%}
    <div class="flex flex-col gap-2" style="flex: 3 1 0; min-width: 0;">
      <div class="flex grow min-h-0 gap-2">
        <div class="flex flex-col shrink-0">
          <span class="val val-xxl tnums" data-pixel-perfect="true">{{ sensors.outdoor.temp }}°</span>
          <span class="val text-3xl tnums !leading-none whitespace-nowrap">{{ sensors.outdoor.humidity }}&thinsp;% <span class="lbl lbl-md lbl-gray">vlhkost</span></span>
        </div>
        <div id="today-chart" class="grow min-w-0 min-h-0"></div>
      </div>
    </div>

  </div>

  <div class="sep"></div>

  {%- comment -%}=== 7-Day Forecast ==={%- endcomment -%}
  <div class="grid grid-cols-7 gap-2">
    {% for day in forecast %}
      <div class="flex flex-col items-center gap-1">
        <span class="lbl lbl-md">{{ day.day }} {{ day.date }}</span>
        {% if day.icon == "sunny" %}{% assign d_icon = svg_sunny %}
        {% elsif day.icon == "rainy" %}{% assign d_icon = svg_rainy %}
        {% elsif day.icon == "partly_cloudy" %}{% assign d_icon = svg_partly_cloudy %}
        {% else %}{% assign d_icon = svg_cloudy %}{% endif %}
        <img src="data:image/svg+xml;base64,{{ d_icon | base64_encode }}" class="w-8 h-8">
        <span class="val val-sm tnums">{{ day.temp_max }}° / {{ day.temp_min }}°</span>
        <span class="lbl lbl-sm">{{ day.precipitation }}% · {{ day.precipitation_mm }} mm</span>
      </div>
    {% endfor %}
  </div>

  <div class="sep"></div>

  {%- comment -%}=== BOTTOM: Calendar ==={%- endcomment -%}
  <div class="flex flex-col gap-1 bg-neutral-200 px-4 py-3 rounded-xl overflow-hidden">
    <span class="ttl">KALENDÁŘ</span>
    <div class="flex gap-2">
      <span class="lbl lbl-sm lbl-gray shrink-0" style="width: 3rem;">Dnes</span>
      <div class="flex flex-col gap-1">
        {% for event in events_today %}
          <div class="item-row">
            <span class="lbl lbl-sm tnums">{{ event.time }}</span>
            <span class="desc">{{ event.title }}</span>
          </div>
        {% endfor %}
      </div>
    </div>
    {% if events_tomorrow.size > 0 %}
      <div class="flex gap-2">
        <span class="lbl lbl-sm lbl-gray shrink-0" style="width: 3rem;">Zítra</span>
        <div class="flex flex-col gap-1">
          {% for event in events_tomorrow %}
            <div class="item-row">
              <span class="lbl lbl-sm tnums">{{ event.time }}</span>
              <span class="desc">{{ event.title }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <div class="flex items-center px-4 py-1.5 bg-neutral-200 rounded-xl text-sm shrink-0">
    <span class="text-gray-700">{{ current_date.day_name }} {{ current_date.day }}. {{ current_date.month }} {{ current_date.year }} · Svátek: {{ nameday }}</span>
    <span class="ml-auto text-gray-700">Baterie {{ trmnl.device.battery }}%</span>
  </div>

</div>

<script>
function createTodayChart() {
  var hourly = {{ weather.today_hourly | json }};
  var categories = hourly.map(function(h) { return h.time; });
  var rawTemps = hourly.map(function(h) { return h.temp; });
  var precip = hourly.map(function(h) { return h.precipitation_mm; });
  var tMax = Math.max.apply(null, rawTemps);
  var tMin = Math.min.apply(null, rawTemps);
  var tRange = tMax - tMin || 1;
  var temps = rawTemps.map(function(t, i) {
    var show = (i % 3 === 0) || (i === rawTemps.length - 1);
    var isHigh = (t - tMin) / tRange > 0.7;
    return {
      y: t,
      dataLabels: {
        enabled: show,
        useHTML: true,
        format: '<span style="background:#000;color:#fff;padding:1px 4px;border-radius:2px;font-size:14px;font-weight:600;">{y}°</span>',
        y: isHigh ? 16 : -12,
        overflow: 'allow',
        crop: false
      }
    };
  });

  Highcharts.chart('today-chart', {
    chart: {
      backgroundColor: 'transparent',
      animation: false,
      spacing: [4, 20, 0, 16],
      height: null
    },
    title: { text: null },
    credits: { enabled: false },
    legend: { enabled: false },
    tooltip: { enabled: false },
    xAxis: {
      categories: categories,
      lineColor: '#aaa',
      tickLength: 0,
      labels: {
        step: 3,
        format: '{value}:00',
        style: { fontSize: '18px', color: '#666' }
      }
    },
    yAxis: [{
      title: { text: null },
      labels: { enabled: false },
      gridLineColor: '#ccc',
      gridLineDashStyle: 'ShortDot'
    }, {
      title: { text: null },
      labels: { enabled: false },
      opposite: true,
      min: 0,
      gridLineWidth: 0
    }],
    plotOptions: {
      series: { animation: false, enableMouseTracking: false }
    },
    series: [{
      type: 'line',
      name: 'Teplota',
      data: temps,
      yAxis: 0,
      zIndex: 1,
      color: '#000',
      lineWidth: 2,
      marker: { radius: 3, fillColor: '#000' }
    }, {
      type: 'column',
      name: 'Srážky',
      data: precip,
      yAxis: 1,
      zIndex: 0,
      color: '#ccc',
      borderWidth: 0,
      pointWidth: 9,
      dataLabels: { enabled: false }
    }]
  });
}

if (typeof Highcharts !== 'undefined') {
  createTodayChart();
} else {
  document.querySelector('script[src*="highcharts"]').addEventListener('load', createTodayChart);
}
</script>

