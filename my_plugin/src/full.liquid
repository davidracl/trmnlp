<script src="https://cdn.tailwindcss.com"></script>
<style>
* { font-family: 'Inter', sans-serif; }
/* Typography */
.val       { font-weight: 600; line-height: 1; margin-top: 2px; }
.val-xxl   { font-size: 4rem; }
.val-sm    { font-size: 1rem; }
.tnums     { font-variant-numeric: tabular-nums; }

.ttl       { font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 1rem; }
.ttl-sm    { font-size: 0.875rem; }

.lbl       { font-size: 0.9375rem; }
.lbl-sm    { font-size: 0.8125rem; }
.lbl-md    { font-size: 1.0625rem; }
.lbl-gray  { color: #888; }

.desc      { font-size: 1rem; }

/* Separators */
.sep       { height: 1px; background: #000; width: 100%; }
.sep-v     { width: 1px; background: #000; align-self: stretch; }

/* Equal panels (sep-v excluded) */

/* Item rows */
.item-row         { display: flex; gap: 0.5rem; align-items: baseline; }
.item-row .meta   { flex-shrink: 0; }

/* Section card with legend */
.section-card { border: 1px solid #ccc; border-radius: 1rem; padding: 0.75rem; position: relative; }
.section-card legend { font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.8125rem; color: #888; padding: 0 0.5rem; margin-left: 0.5rem; }
</style>

{%- comment -%}=== Weather Icon SVGs ==={%- endcomment -%}

{%- capture svg_sunny -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="none" stroke="black" stroke-width="2.5" stroke-linecap="round"><circle cx="16" cy="16" r="5" fill="black"/><line x1="16" y1="3" x2="16" y2="7"/><line x1="16" y1="25" x2="16" y2="29"/><line x1="5.4" y1="5.4" x2="8.2" y2="8.2"/><line x1="23.8" y1="23.8" x2="26.6" y2="26.6"/><line x1="3" y1="16" x2="7" y2="16"/><line x1="25" y1="16" x2="29" y2="16"/><line x1="5.4" y1="26.6" x2="8.2" y2="23.8"/><line x1="23.8" y1="8.2" x2="26.6" y2="5.4"/></svg>{%- endcapture -%}

{%- capture svg_cloudy -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="black"><path d="M8 24c-3 0-5.5-2.5-5.5-5.5 0-2.7 2-5 4.6-5.4C8.3 9.5 11.5 7 15.5 7c4.8 0 8.7 3.6 9 8.2C26.8 16 28.5 18 28.5 20.2c0 2.5-2 3.8-4 3.8H8z"/></svg>{%- endcapture -%}

{%- capture svg_rainy -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path fill="black" d="M8 19c-3 0-5.5-2.5-5.5-5.5 0-2.7 2-5 4.6-5.4C8.3 4.5 11.5 2 15.5 2c4.8 0 8.7 3.6 9 8.2C26.8 11 28.5 13 28.5 15.2c0 2.5-2 3.8-4 3.8H8z"/><line x1="10" y1="23" x2="8" y2="29" stroke="black" stroke-width="2.5" stroke-linecap="round"/><line x1="16" y1="23" x2="14" y2="29" stroke="black" stroke-width="2.5" stroke-linecap="round"/><line x1="22" y1="23" x2="20" y2="29" stroke="black" stroke-width="2.5" stroke-linecap="round"/></svg>{%- endcapture -%}

{%- capture svg_partly_cloudy -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><circle cx="12" cy="9" r="4" fill="none" stroke="black" stroke-width="2"/><line x1="12" y1="1" x2="12" y2="3" stroke="black" stroke-width="2" stroke-linecap="round"/><line x1="6.3" y1="3.3" x2="7.7" y2="4.7" stroke="black" stroke-width="2" stroke-linecap="round"/><line x1="4" y1="9" x2="6" y2="9" stroke="black" stroke-width="2" stroke-linecap="round"/><line x1="6.3" y1="14.7" x2="7.7" y2="13.3" stroke="black" stroke-width="2" stroke-linecap="round"/><path fill="black" d="M10 26c-2.5 0-4.5-2-4.5-4.5 0-2.2 1.6-4 3.7-4.4C10 14 12.8 12 16 12c3.8 0 6.9 2.9 7.2 6.5 1.8.7 3.3 2.5 3.3 4.2 0 2.2-1.7 3.3-3.5 3.3H10z"/></svg>{%- endcapture -%}

{%- capture svg_home -%}<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>{%- endcapture -%}

<script src="https://trmnl.com/js/highcharts/12.3.0/highcharts.js"></script>

<div class="flex flex-col gap-4 grow min-h-0 p-2" style="position: relative;">

  {%- comment -%}=== TOP: Home Sensors ==={%- endcomment -%}
  <div class="flex gap-4 top-panels items-stretch">

    {%- comment -%}--- DOMA panel ---{%- endcomment -%}
    <div class="flex flex-col gap-3" style="flex: 1.3 1 0; min-width: 0;">
      <fieldset class="section-card flex flex-col gap-2">
        <legend>Obývák</legend>
        <div class="flex gap-3">
          <div class="flex flex-col flex-1">
            <div class="border-l-4 border-neutral-400 pl-3 py-1">
              <span class="lbl lbl-sm lbl-gray">Teplota</span>
              <span class="val text-4xl tnums block" data-pixel-perfect="true">{{ sensors.indoor.temp }}&thinsp;°</span>
            </div>
            <div id="spark-temp" style="height: 90px; width: 100%; overflow: visible; margin-top: -4px;"></div>
          </div>
          <div class="flex flex-col flex-1">
            <div class="border-l-4 border-neutral-400 pl-3 py-1">
              <span class="lbl lbl-sm lbl-gray">Vlhkost</span>
              <span class="val text-4xl tnums block" data-pixel-perfect="true">{{ sensors.indoor.humidity }}&thinsp;%</span>
            </div>
            <div id="spark-humidity" style="height: 90px; width: 100%; overflow: visible; margin-top: -4px;"></div>
          </div>
          <div class="flex flex-col flex-1">
            <div class="border-l-4 border-neutral-400 pl-3 py-1">
              <span class="lbl lbl-sm lbl-gray">CO₂</span>
              <span class="val text-4xl tnums block" data-pixel-perfect="true">{{ sensors.indoor.co2 }}&thinsp;<span class="text-xl">ppm</span></span>
            </div>
            <div id="spark-co2" style="height: 90px; width: 100%; overflow: visible; margin-top: -4px;"></div>
          </div>
        </div>
      </fieldset>
      <fieldset class="section-card flex flex-col gap-2">
        <legend>Další místnosti</legend>
        <div class="flex gap-3">
          {% for room in sensors.rooms %}
            <div class="flex flex-col flex-1">
              <div class="border-l-4 border-neutral-400 pl-3 py-1">
                <span class="lbl lbl-sm lbl-gray">{{ room.name }}</span>
                <span class="val text-2xl tnums block" data-pixel-perfect="true">{{ room.temp }}&thinsp;°</span>
              </div>
            </div>
          {% endfor %}
        </div>
      </fieldset>
    </div>

    {%- comment -%}--- VENKU panel ---{%- endcomment -%}
    <fieldset class="section-card flex flex-col gap-2" style="flex: 1 1 0; min-width: 0; height: 100%;">
      <legend>Venku</legend>
      <div class="flex gap-3 shrink-0">
        <div class="flex flex-col flex-1">
          <div class="border-l-4 border-neutral-400 pl-3 py-1">
            <span class="lbl lbl-sm lbl-gray">Teplota</span>
            <span class="val text-4xl tnums block" data-pixel-perfect="true">{{ sensors.outdoor.temp }}&thinsp;°</span>
          </div>
        </div>
        <div class="flex flex-col flex-1">
          <div class="border-l-4 border-neutral-400 pl-3 py-1">
            <span class="lbl lbl-sm lbl-gray">Vlhkost</span>
            <span class="val text-4xl tnums block" data-pixel-perfect="true">{{ sensors.outdoor.humidity }}&thinsp;%</span>
          </div>
        </div>
        <div class="flex flex-col flex-1">
          <div class="border-l-4 border-neutral-400 pl-3 py-1">
            <span class="lbl lbl-sm lbl-gray">UV index</span>
            <span class="val text-4xl tnums block" data-pixel-perfect="true">{{ sensors.outdoor.uv }}</span>
          </div>
        </div>
      </div>
      <div id="today-chart" style="flex: 1 1 0; min-width: 0; min-height: 60px;"></div>
    </fieldset>

  </div>

  {%- comment -%}=== 7-Day Forecast ==={%- endcomment -%}
  <fieldset class="section-card" style="padding-top: 1rem; padding-bottom: 0.75rem;">
    <legend>Příštích 7 dní</legend>
    <div class="grid grid-cols-7 gap-2">
      {% for day in forecast %}
        <div class="flex flex-col items-center gap-1.5">
          <span class="lbl lbl-md">{{ day.day }} {{ day.date }}</span>
          {% if day.icon == "sunny" %}{% assign d_icon = svg_sunny %}
          {% elsif day.icon == "rainy" %}{% assign d_icon = svg_rainy %}
          {% elsif day.icon == "partly_cloudy" %}{% assign d_icon = svg_partly_cloudy %}
          {% else %}{% assign d_icon = svg_cloudy %}{% endif %}
          <img src="data:image/svg+xml;base64,{{ d_icon | base64_encode }}" class="w-8 h-8">
          <span class="val val-sm tnums">{{ day.temp_max }}° / {{ day.temp_min }}°</span>
          <span class="lbl lbl-sm">{{ day.precipitation }}% · {{ day.precipitation_mm }} mm</span>
        </div>
      {% endfor %}
    </div>
  </fieldset>

  {%- comment -%}=== BOTTOM: Calendar (Apple-style) ==={%- endcomment -%}
  <div class="flex gap-4 grow min-h-0">

    {%- comment -%}--- Dnes ---{%- endcomment -%}
    <div class="flex flex-col flex-1 min-w-0">
      <div class="flex items-baseline gap-2 mb-2">
        <span style="font-size: 2rem; font-weight: 700; line-height: 1;" data-pixel-perfect="true">{{ current_date.day }}</span>
        <span style="font-size: 0.9375rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;">Dnes</span>
      </div>
      <div class="flex flex-col gap-1.5">
        {% for event in events_today %}
          {% if event.calendar == "work" %}{% assign cal_border = "#000" %}
          {% elsif event.calendar == "family" %}{% assign cal_border = "#999" %}
          {% else %}{% assign cal_border = "#bbb" %}{% endif %}
          <div style="display: flex; align-items: stretch; background: #f3f3f3; border-radius: 0.5rem; overflow: hidden;">
            <div style="width: 4px; background: {{ cal_border }}; flex-shrink: 0;"></div>
            <div style="padding: 0.4rem 0.6rem; display: flex; align-items: baseline; gap: 0.5rem;">
              <span style="font-size: 0.9375rem; font-weight: 500; line-height: 1.2;">{{ event.title }}</span>
              <span class="tnums" style="font-size: 0.75rem; color: #888; white-space: nowrap;">{{ event.time }}{% if event.end_time %} – {{ event.end_time }}{% endif %}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    {%- comment -%}--- Separator ---{%- endcomment -%}
    <div style="width: 1px; background: #ddd; align-self: stretch;"></div>

    {%- comment -%}--- Zítra ---{%- endcomment -%}
    {% if events_tomorrow.size > 0 %}
    <div class="flex flex-col flex-1 min-w-0">
      <div class="flex items-baseline gap-2 mb-2">
        <span style="font-size: 2rem; font-weight: 700; line-height: 1; color: #999;" data-pixel-perfect="true">{{ current_date.day | plus: 1 }}</span>
        <div class="flex flex-col">
          <span style="font-size: 0.9375rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: #888;">Zítra</span>
        </div>
      </div>
      <div class="flex flex-col gap-1.5">
        {% for event in events_tomorrow %}
          {% if event.calendar == "work" %}{% assign cal_border = "#000" %}
          {% elsif event.calendar == "family" %}{% assign cal_border = "#999" %}
          {% else %}{% assign cal_border = "#bbb" %}{% endif %}
          <div style="display: flex; align-items: stretch; background: #f3f3f3; border-radius: 0.5rem; overflow: hidden;">
            <div style="width: 4px; background: {{ cal_border }}; flex-shrink: 0;"></div>
            <div style="padding: 0.4rem 0.6rem; display: flex; align-items: baseline; gap: 0.5rem;">
              <span style="font-size: 0.9375rem; font-weight: 500; line-height: 1.2;">{{ event.title }}</span>
              <span class="tnums" style="font-size: 0.75rem; color: #888; white-space: nowrap;">{{ event.time }}{% if event.end_time %} – {{ event.end_time }}{% endif %}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>

  <div style="position: absolute; bottom: 0.5rem; right: 0.5rem; display: flex; align-items: center; gap: 0.5rem; background: #e8e8e8; border-radius: 9999px; padding: 0.25rem 0.625rem; font-size: 0.75rem; color: #777;">
    <span class="flex items-center gap-1">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="12" height="12" fill="none" stroke="#999" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 8a7 7 0 0 1 13-3.5M15 8a7 7 0 0 1-13 3.5"/>
        <polyline points="1,2 1,5 4,5"/>
        <polyline points="15,14 15,11 12,11"/>
      </svg>
      {{ last_updated }}
    </span>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 20" width="32" height="16" fill="none" stroke="#999" stroke-width="1.5">
      <rect x="1" y="2" width="34" height="16" rx="2"/>
      <rect x="35" y="6" width="4" height="8" rx="1" fill="#999" stroke="none"/>
      <rect x="2.5" y="3.5" width="{{ trmnl.device.battery | times: 31 | divided_by: 100 }}" height="13" rx="1" fill="#999" stroke="none"/>
      <text x="18" y="14" text-anchor="middle" fill="white" stroke="none" font-size="10" font-weight="600" font-family="Inter, sans-serif">{{ trmnl.device.battery }}</text>
    </svg>
  </div>

</div>

<script>
function createSparkline(container, data, unit) {
  var minVal = Math.min.apply(null, data);
  var maxVal = Math.max.apply(null, data);
  var minIdx = data.indexOf(minVal);
  var maxIdx = data.indexOf(maxVal);
  var last = data.length - 1;
  var points = data.map(function(v, i) {
    var isMin = (i === minIdx);
    var isMax = (i === maxIdx);
    var isFirst = (i === 0);
    var isLast = (i === last);
    return {
      y: v,
      marker: { enabled: isMin || isMax || isLast, radius: isLast ? 4 : 3, fillColor: '#000', symbol: 'circle' },
      dataLabels: {
        enabled: isMin || isMax,
        format: '{y}' + (unit || ''),
        style: { fontSize: '11px', fontWeight: '600', color: '#000', textOutline: 'none' },
        y: isMax ? 1 : 24,
        align: isFirst ? 'left' : (isLast ? 'right' : 'center'),
        x: isFirst ? 4 : (isLast ? -4 : 0),
        overflow: 'allow',
        crop: false
      }
    };
  });

  Highcharts.chart(container, {
    chart: { backgroundColor: 'transparent', animation: false, spacing: [8, 8, 12, 8], height: 90 },
    title: { text: null },
    credits: { enabled: false },
    legend: { enabled: false },
    tooltip: { enabled: false },
    xAxis: { visible: false },
    yAxis: { visible: false, gridLineWidth: 0, maxPadding: 0.1, minPadding: 0.15 },
    plotOptions: { series: { animation: false, enableMouseTracking: false } },
    series: [{
      type: 'area',
      data: points,
      color: '#000',
      lineWidth: 1.5,
      marker: { enabled: false },
      fillColor: { linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 }, stops: [[0, '#00000030'], [1, '#00000005']] }
    }]
  });
}

function createSparklines() {
  var history = {{ sensors.indoor.history | json }};
  if (history) {
    if (history.temp) createSparkline('spark-temp', history.temp, '°');
    if (history.humidity) createSparkline('spark-humidity', history.humidity, '%');
    if (history.co2) createSparkline('spark-co2', history.co2, '');
  }
}

function createTodayChart() {
  var hourly = {{ weather.today_hourly | json }};
  var categories = hourly.map(function(h) { return h.time; });
  var rawTemps = hourly.map(function(h) { return h.temp; });
  var precip = hourly.map(function(h) { return h.precipitation_mm; });
  var tMax = Math.max.apply(null, rawTemps);
  var tMin = Math.min.apply(null, rawTemps);
  var tRange = tMax - tMin || 1;
  var temps = rawTemps.map(function(t, i) {
    var show = (i % 3 === 0) || (i === rawTemps.length - 1);
    var isHigh = (t - tMin) / tRange > 0.7;
    return {
      y: t,
      dataLabels: {
        enabled: show,
        useHTML: true,
        format: '<span style="background:#000;color:#fff;padding:1px 4px;border-radius:2px;font-size:14px;font-weight:600;">{y}°</span>',
        y: isHigh ? 15 : -12,
        overflow: 'allow',
        crop: false
      }
    };
  });

  Highcharts.chart('today-chart', {
    chart: {
      backgroundColor: 'transparent',
      animation: false,
      spacing: [4, 20, 0, 16],
      height: null
    },
    title: { text: null },
    credits: { enabled: false },
    legend: { enabled: false },
    tooltip: { enabled: false },
    xAxis: {
      categories: categories,
      lineColor: '#aaa',
      tickLength: 0,
      labels: {
        step: 3,
        format: '{value}:00',
        style: { fontSize: '18px', color: '#666' }
      }
    },
    yAxis: [{
      title: { text: null },
      labels: { enabled: false },
      gridLineWidth: 0
    }, {
      title: { text: null },
      labels: { enabled: false },
      opposite: true,
      min: 0,
      gridLineWidth: 0
    }],
    plotOptions: {
      series: { animation: false, enableMouseTracking: false }
    },
    series: [{
      type: 'line',
      name: 'Teplota',
      data: temps,
      yAxis: 0,
      zIndex: 1,
      color: '#000',
      lineWidth: 2,
      marker: { radius: 3, fillColor: '#000' }
    }, {
      type: 'column',
      name: 'Srážky',
      data: precip,
      yAxis: 1,
      zIndex: 0,
      color: '#ccc',
      borderWidth: 0,
      pointWidth: 9,
      dataLabels: { enabled: false }
    }]
  });
}

function initCharts() {
  createTodayChart();
  createSparklines();
}

if (typeof Highcharts !== 'undefined') {
  initCharts();
} else {
  document.querySelector('script[src*="highcharts"]').addEventListener('load', initCharts);
}
</script>

